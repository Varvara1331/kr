@{
    ViewData["Title"] = "Генератор временных ссылок";
    ViewData["PageDescription"] = "Создание и управление ссылками для доступа сотрудников";
    Layout = "_Layout";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card fade-in">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-link-45deg me-2"></i>Создание временной ссылки
                    </h4>
                </div>
                <div class="card-body">
                    @if (ViewBag.Success != null && ViewBag.Success == true)
                    {
                        <div class="alert alert-success fade-in">
                            @if (ViewBag.IsUpdated != null && ViewBag.IsUpdated == true)
                            {
                                <h5 class="alert-heading">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Ссылка обновлена!
                                </h5>
                                <p class="mb-0">
                                    Для сотрудника <strong>@ViewBag.FullName</strong> была создана новая ссылка.
                                    Старая ссылка больше не действительна.
                                </p>
                            }
                            else
                            {
                                <h5 class="alert-heading">
                                    <i class="bi bi-check-circle me-2"></i>Новый сотрудник добавлен!
                                </h5>
                                <p class="mb-0">
                                    Сотрудник <strong>@ViewBag.FullName</strong> добавлен в систему.
                                </p>
                            }
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <strong>
                                            <i class="bi bi-envelope me-1"></i>Email:
                                        </strong>
                                        @ViewBag.EmployeeEmail
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-0">
                                        <strong>
                                            <i class="bi bi-clock me-1"></i>Действует до:
                                        </strong>
                                        @ViewBag.ExpiresAt (UTC)
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4 fade-in">
                            <label class="form-label fw-bold mb-2">
                                <i class="bi bi-link me-1"></i>Ссылка для сотрудника:
                            </label>
                            <div class="input-group mb-2">
                                <input type="text"
                                       class="form-control"
                                       id="generatedLink"
                                       value="@ViewBag.GeneratedLink"
                                       readonly
                                       aria-label="Сгенерированная ссылка">
                                <button class="btn btn-outline-secondary"
                                        type="button"
                                        id="copyButton"
                                        data-copy-target="#generatedLink">
                                    <i class="bi bi-clipboard me-1"></i>Копировать
                                </button>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Скопируйте эту ссылку и отправьте сотруднику
                            </small>
                        </div>

                        <hr class="my-4">
                    }

                    @if (ViewBag.Error != null)
                    {
                        <div class="alert alert-danger fade-in">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            @ViewBag.Error
                        </div>
                    }

                    <form method="post" action="/admin/createlink" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="fullName" class="form-label">
                                <i class="bi bi-person me-1"></i>ФИО сотрудника *
                            </label>
                            <input type="text"
                                   class="form-control"
                                   id="fullName"
                                   name="fullName"
                                   required
                                   placeholder="Иванов Иван Иванович">
                            <div class="invalid-feedback">
                                Пожалуйста, укажите ФИО сотрудника.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="employeeEmail" class="form-label">
                                <i class="bi bi-envelope me-1"></i>Email сотрудника *
                            </label>
                            <input type="email"
                                   class="form-control"
                                   id="employeeEmail"
                                   name="employeeEmail"
                                   required
                                   placeholder="ivanov@example.com">
                            <div class="invalid-feedback">
                                Пожалуйста, укажите корректный email адрес.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">
                                <i class="bi bi-key me-1"></i>Пароль сотрудника *
                            </label>
                            <input type="password"
                                   class="form-control"
                                   id="password"
                                   name="password"
                                   required>
                            <div class="invalid-feedback">
                                Пожалуйста, укажите корректный пароль.
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="durationMinutes" class="form-label">
                                <i class="bi bi-clock me-1"></i>Длительность ссылки (минут) *
                            </label>
                            <input type="number"
                                   class="form-control"
                                   id="durationMinutes"
                                   name="durationMinutes"
                                   min="1"
                                   max="10080"
                                   value="60"
                                   required>
                            <div class="invalid-feedback">
                                Укажите длительность от 1 до 10080 минут.
                            </div>
                            <small class="text-muted">
                                От 1 минуты до 7 дней (10080 минут)
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-2">
                            <i class="bi bi-magic me-2"></i>Сгенерировать ссылку
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('fullName')?.focus();

            const form = document.querySelector('.needs-validation');
            if (form) {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            }

        @if (ViewBag.Success != null && ViewBag.Success == true)
        {
            <text>
                    setTimeout(() => {
                        const successAlert = document.querySelector('.alert-success');
                        if (successAlert) {
                            successAlert.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }
                    }, 100);
            </text>
        }

            const copyButton = document.getElementById('copyButton');
            if (copyButton) {
                copyButton.addEventListener('click', function() {
                    const input = document.getElementById('generatedLink');
                    if (!input) {
                        alert('Ссылка не найдена');
                        return;
                    }

                    input.select();
                    input.setSelectionRange(0, 99999);

                    navigator.clipboard.writeText(input.value)
                        .then(() => {
                            const originalHTML = this.innerHTML;
                            this.innerHTML = '<i class="bi bi-check-lg me-1"></i>Скопировано!';
                            this.classList.remove('btn-outline-secondary');
                            this.classList.add('btn-success');

                            setTimeout(() => {
                                this.innerHTML = originalHTML;
                                this.classList.remove('btn-success');
                                this.classList.add('btn-outline-secondary');
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Ошибка копирования:', err);
                            alert('Не удалось скопировать ссылку');
                        });
                });
            }
        });
    </script>
}